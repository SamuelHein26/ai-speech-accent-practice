# syntax=docker/dockerfile:1
# --- base image with Python toolchain (CPU only) ---
FROM python:3.11-slim

# --- system deps: ffmpeg + build basics ---
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg libpq5 build-essential \
 && rm -rf /var/lib/apt/lists/*

# --- working dir and deps ---
WORKDIR /app
COPY backend/requirements.txt ./requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# --- app code ---
COPY backend /app

# --- create folders for runtime persistence ---
RUN mkdir -p /app/recordings /app/live_sessions

# --- env (override in compose/prod) ---
ENV PYTHONUNBUFFERED=1
ENV PORT=8000

# --- entrypoint: run migrations then app ---
# NOTE: we rely on alembic.ini/env.py to read DATABASE_URL from env
CMD ["/bin/bash", "-lc", "\
  alembic upgrade head && \
  uvicorn main:app --host 0.0.0.0 --port ${PORT} \
"]